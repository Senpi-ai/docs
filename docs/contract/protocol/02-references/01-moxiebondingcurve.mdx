# MoxieBondingCurve.sol

Bonding curve contract which enables subject onboarding, buy & sell of subject shares.

## Functions

### initialize

Initialize the contract.

```js
function initialize(
    address _token,
    address _formula,
    address _owner,
    address _tokenManager,
    address _vault,
    FeeInput memory _feeInput,
    address _feeBeneficiary,
    address _subjectFactory
) external initializer {}
```

#### Parameters

| Name              | Type     | Description                         |
| :---------------- | :------- | :---------------------------------- |
| `_token`          | address  | Moxie token address.                |
| `_formula`        | address  | Bancors formula contract address.   |
| `_owner`          | address  | Owner of contract.                  |
| `_tokenManager`   | address  | Address of token manager contract.  |
| `_vault`          | address  | Address of vault contract address.  |
| `_feeInput`       | FeeInput | subject & protocol Feeinput struct. |
| `_feeBeneficiary` | address  | Protocol fee beneficiary.           |
| `_subjectFactory` | address  | Subject Factory address.            |

### \_validateInput

Internal function to validate initialization input.

```js
function _validateInput(
    address _token,
    address _formula,
    address _owner,
    address _tokenManager,
    address _vault,
    address _feeBeneficiary,
    address _subjectFactory
) internal pure {}
```

#### Parameters

| Name              | Type    | Description                        |
| :---------------- | :------ | :--------------------------------- |
| `_token`          | address | Moxie token address.               |
| `_formula`        | address | Bancors formula contract address.  |
| `_owner`          | address | Owner of contract.                 |
| `_tokenManager`   | address | Address of token manager contract. |
| `_vault`          | address | Address of vault contract address. |
| `_feeBeneficiary` | address | Protocol fee beneficiary.          |
| `_subjectFactory` | address | Subject Factory address.           |

### \_validateFee

Internal function to validate Fee params.

```js
function _validateFee(FeeInput memory _feeInput) internal pure {}
```

#### Parameters

| Name        | Type     | Description      |
| :---------- | :------- | :--------------- |
| `_feeInput` | FeeInput | Feeinput struct. |

### \_updateFeeBeneficiary

Internal function to update fee beneficiary.

```js
function _updateFeeBeneficiary(address _beneficiary) internal {}
```

#### Parameters

| Name           | Type    | Description            |
| :------------- | :------ | :--------------------- |
| `_beneficiary` | address | Address of beneficiary |

### \_updateFormula

Internal function to update bancor formula.

```js
function _updateFormula(IBancorFormula _formula) internal {}
```

#### Parameters

| Name       | Type           | Description                  |
| :--------- | :------------- | :--------------------------- |
| `_formula` | IBancorFormula | Address of formula contract. |

### \_feeIsValid

Internal function to validate fee.

```js
function _feeIsValid(uint256 _fee) internal pure returns (bool) {}
```

#### Parameters

| Name   | Type    | Description      |
| :----- | :------ | :--------------- |
| `_fee` | uint256 | Fee in PCT_Base. |

#### Return Value

| Name      | Type | Description           |
| :-------- | :--- | :-------------------- |
| `isValid` | bool | True if fee is valid. |

### \_isZeroAddress

Internal function to validate if an address is a zero address.

```js
function _isZeroAddress(address _address) internal pure returns (bool) {}
```

#### Parameters

| Name       | Type    | Description          |
| :--------- | :------ | :------------------- |
| `_address` | address | Address to validate. |

#### Return Value

| Name            | Type | Description                                                  |
| :-------------- | :--- | :----------------------------------------------------------- |
| `isZeroAddress` | bool | `true` if the address is a zero address. Otherwise, `false`. |

### \_reserveRatioIsValid

Internal function to validate reserve ratio.

```js
function _reserveRatioIsValid(
    uint32 _reserveRatio
) internal pure returns (bool) {}
```

#### Parameters

| Name            | Type   | Description           |
| :-------------- | :----- | :-------------------- |
| `_reserveRatio` | uint32 | Reserve ratio in PPM. |

#### Return Value

| Name      | Type | Description                                           |
| :-------- | :--- | :---------------------------------------------------- |
| `isValid` | bool | `true` if reserve ratio is valid. Otherwise, `false`. |

### \_updateFees

Internal function to update fee.

```js
/**
 * @dev Internal function to update fee.
 * @param _protocolBuyFeePct Protocol fee percentage applied during buy share transaction.
 * @param _protocolSellFeePct Subject fee percentage applied during sell share transaction.
 * @param _subjectBuyFeePct Subject fee percentage applied during buy share transaction.
 * @param _subjectSellFeePct Subject fee percentage applied during sell share transaction.
 */
function _updateFees(
    uint256 _protocolBuyFeePct,
    uint256 _protocolSellFeePct,
    uint256 _subjectBuyFeePct,
    uint256 _subjectSellFeePct
) internal {}
```

#### Parameters

| Name                  | Type    | Description                                                    |
| :-------------------- | :------ | :------------------------------------------------------------- |
| `_protocolBuyFeePct`  | uint256 | Protocol fee percentage applied during buy share transaction.  |
| `_protocolSellFeePct` | uint256 | Protocol fee percentage applied during sell share transaction. |
| `_subjectBuyFeePct`   | uint256 | Subject fee percentage applied during buy share transaction.   |
| `_subjectSellFeePct`  | uint256 | Subject fee percentage applied during sell share transaction.  |

### \_buyShares

Internal function to buy shares of a subject.

```js
function _buyShares(
    IERC20Extended _subjectToken,
    uint256 _depositAmount,
    address _onBehalfOf,
    uint256 _minReturnAmountAfterFee,
    address _subject,
    uint32 _subjectReserveRatio
) internal returns (uint256 shares_) {}
```

#### Parameters

| Name                       | Type           | Description                                                                               |
| :------------------------- | :------------- | :---------------------------------------------------------------------------------------- |
| `_subjectToken`            | IERC20Extended | Address of Subject Token.                                                                 |
| `_depositAmount`           | uint256        | Amount of deposit to buy shares.                                                          |
| `_onBehalfOf`              | address        | Address of beneficiary where shares will be minted. This address can be zero address too. |
| `_minReturnAmountAfterFee` | uint256        | Minimum number of shares that must be received.                                           |
| `_subject`                 | address        | Address of subject.                                                                       |
| `_subjectReserveRatio`     | uint32         | Subject Reserve ratio.                                                                    |

#### Return Value

| Name      | Type    | Description       |
| :-------- | :------ | :---------------- |
| `shares_` | uint256 | Number of shares. |

### \_sellShares

Internal function to sell shares of a subject.

```js
function _sellShares(
    IERC20Extended _subjectToken,
    uint256 _sellAmount,
    address _onBehalfOf,
    uint256 _minReturnAmountAfterFee,
    address _subject,
    uint32 _subjectReserveRatio
) internal returns (uint256 returnedAmount_) {}
```

#### Parameters

| Name                       | Type           | Description                                                                                |
| :------------------------- | :------------- | :----------------------------------------------------------------------------------------- |
| `_subjectToken`            | IERC20Extended | Address of Subject Token.                                                                  |
| `_sellAmount`              | uint256        | Amount of shares to sell.                                                                  |
| `_onBehalfOf`              | address        | Address of beneficiary where funds will be returned. This address can be zero address too. |
| `_minReturnAmountAfterFee` | uint256        | Minimum amount of funds that should be returned.                                           |
| `_subject`                 | address        | Address of subject.                                                                        |
| `_subjectReserveRatio`     | uint32         | Subject Reserve ratio.                                                                     |

#### Return Value

| Name              | Type    | Description      |
| :---------------- | :------ | :--------------- |
| `returnedAmount_` | uint256 | Amount of funds. |

### \_calculateBuySideFee

Internal function to calculate the buy-side fee.

```js
function _calculateBuySideFee(
    uint256 _depositAmount
) internal view returns (uint256 protocolFee_, uint256 subjectFee_) {}
```

#### Parameters

| Name             | Type    | Description            |
| :--------------- | :------ | :--------------------- |
| `_depositAmount` | uint256 | Deposit amount for buy |

#### Return Value

| Name           | Type    | Description                        |
| :------------- | :------ | :--------------------------------- |
| `protocolFee_` | uint256 | Buy side protocol fee in PCT_BASE. |
| `subjectFee_`  | uint256 | Buy side subject fee in PCT_BASE.  |

### \_calculateSellSideFee

Internal function to calculate the sell-side fee.

```js
function _calculateSellSideFee(
    uint256 _sellAmount
) internal view returns (uint256 protocolFee_, uint256 subjectFee_) {}
```

#### Parameters

| Name          | Type    | Description                      |
| :------------ | :------ | :------------------------------- |
| `_sellAmount` | uint256 | Amount of subject shares to sell |

#### Return Value

| Name           | Type    | Description                         |
| :------------- | :------ | :---------------------------------- |
| `protocolFee_` | uint256 | Sell side protocol fee in PCT_BASE. |
| `subjectFee_`  | uint256 | Sell side subject fee in PCT_BASE.  |

### \_sellSharesInternal

Internal function to sell subject shares.

```js
function _sellSharesInternal(
    address _subject,
    uint256 _sellAmount,
    address _onBehalfOf,
    uint256 _minReturnAmountAfterFee
) internal whenNotPaused returns (uint256 returnAmount_) {}
```

#### Parameters

| Name                       | Type    | Description                                   |
| :------------------------- | :------ | :-------------------------------------------- |
| `_subject`                 | address | Address of subject.                           |
| `_sellAmount`              | uint256 | Amount of subject shares to sell.             |
| `_onBehalfOf`              | address | Address of buy token beneficiary.             |
| `_minReturnAmountAfterFee` | uint256 | Minimum of MOXIE token that must be returned. |

#### Return Value

| Name            | Type    | Description                                           |
| :-------------- | :------ | :---------------------------------------------------- |
| `returnAmount_` | uint256 | Amount received in MOXIE from selling subject shares. |

### \_buySharesInternal

Internal function to buy subject shares.

```js
function _buySharesInternal(
    address _subject,
    uint256 _depositAmount,
    address _onBehalfOf,
    uint256 _minReturnAmountAfterFee
) internal returns (uint256 shares_) {}
```

#### Parameters

| Name                       | Type    | Description                                     |
| :------------------------- | :------ | :---------------------------------------------- |
| `_subject`                 | address | Address of subject.                             |
| `_depositAmount`           | uint256 | Amount of deposit to buy shares.                |
| `_onBehalfOf`              | address | Address of beneficiary.                         |
| `_minReturnAmountAfterFee` | uint256 | Minimum number of shares that must be received. |

#### Return Value

| Name      | Type    | Description              |
| :-------- | :------ | :----------------------- |
| `shares_` | uint256 | Number of shares bought. |

### updateFees

Update fee only be called by role UPDATE_FEES_ROLE.

```js
function updateFees(
    FeeInput memory _feeInput
) external onlyRole(UPDATE_FEES_ROLE) {}
```

#### Parameters

| Name        | Type     | Description      |
| :---------- | :------- | :--------------- |
| `_feeInput` | FeeInput | Feeinput struct. |

### updateFormula

Update formula to `_formula`. It can be done by UPDATE_FORMULA_ROLE.

```js
function updateFormula(
    address _formula
) external onlyRole(UPDATE_FORMULA_ROLE) {}
```

#### Parameters

| Name       | Type    | Description                                                 |
| :--------- | :------ | :---------------------------------------------------------- |
| `_formula` | address | The address of the new BancorFormula [computation] contract |

### updateFeeBeneficiary

Update beneficiary to `\_beneficiary. It can be done by UPDATE_BENEFICIARY_ROLE.

```js
function updateFeeBeneficiary(
    address _feeBeneficiary
) external onlyRole(UPDATE_BENEFICIARY_ROLE) {}
```

#### Parameters

| Name              | Type    | Description                                                      |
| :---------------- | :------ | :--------------------------------------------------------------- |
| `_feeBeneficiary` | address | The address of the new beneficiary [to whom fees are to be sent] |

### initializeSubjectBondingCurve

Initialize Bonding curve for subject, it's called by subject factory.

```js
function initializeSubjectBondingCurve(
  address _subject,
  uint32 _reserveRatio,
  uint256 _initialSupply,
  uint256 _reserveAmount
) external whenNotPaused returns (bool) {}
```

#### Parameters

| Name             | Type    | Description                                                                   |
| :--------------- | :------ | :---------------------------------------------------------------------------- |
| `_subject`       | address | Address of subject.                                                           |
| `_reserveRatio`  | uint32  | Initial supply of subject tokens at the time of bonding curve initialization. |
| `_initialSupply` | uint256 | reserve ratio of subject for bonding curve.                                   |
| `_reserveAmount` | uint256 | Initial reserve amount.                                                       |

#### Return Value

| Name            | Type | Description                                                 |
| :-------------- | :--- | :---------------------------------------------------------- |
| `isInitialized` | bool | `true` if bonding curve is initialized. Otherwise, `false`. |

### buySharesFor

Buy shares of a subject on behalf of a beneficiary.

```js
function buySharesFor(
    address _subject,
    uint256 _depositAmount,
    address _onBehalfOf,
    uint256 _minReturnAmountAfterFee
) external whenNotPaused returns (uint256 shares_) {}
```

#### Parameters

| Name                       | Type    | Description                                     |
| :------------------------- | :------ | :---------------------------------------------- |
| `_subject`                 | address | Address of subject.                             |
| `_depositAmount`           | uint256 | Amount of deposit to buy shares.                |
| `_onBehalfOf`              | address | Address of beneficiary.                         |
| `_minReturnAmountAfterFee` | uint256 | Minimum number of shares that must be received. |

#### Return Value

| Name      | Type    | Description       |
| :-------- | :------ | :---------------- |
| `shares_` | uint256 | Number of shares. |

### buyShares

Buy shares of a subject.

```js
function buyShares(
    address _subject,
    uint256 _depositAmount,
    uint256 _minReturnAmountAfterFee
) external whenNotPaused returns (uint256 shares_) {}
```

#### Parameters

| Name                       | Type    | Description                                     |
| :------------------------- | :------ | :---------------------------------------------- |
| `_subject`                 | address | Address of subject.                             |
| `_depositAmount`           | uint256 | Amount of deposit to buy shares.                |
| `_minReturnAmountAfterFee` | uint256 | Minimum number of shares that must be received. |

#### Return Value

| Name      | Type    | Description       |
| :-------- | :------ | :---------------- |
| `shares_` | uint256 | Number of shares. |

### sellSharesFor

Sell shares of a subject on behalf of a beneficiary.

```js
function sellSharesFor(
    address _subject,
    uint256 _sellAmount,
    address _onBehalfOf,
    uint256 _minReturnAmountAfterFee
) external whenNotPaused returns (uint256 returnAmount_) {}
```

#### Parameters

| Name                       | Type    | Description                                     |
| :------------------------- | :------ | :---------------------------------------------- |
| `_subject`                 | address | Address of subject.                             |
| `_sellAmount`              | uint256 | Amount of subject shares to sell.               |
| `_onBehalfOf`              | address | Address of buy token beneficiary.               |
| `_minReturnAmountAfterFee` | uint256 | Minimum number of shares that must be received. |

#### Return Value

| Name            | Type    | Description                                           |
| :-------------- | :------ | :---------------------------------------------------- |
| `returnAmount_` | uint256 | Amount received in MOXIE from selling subject shares. |

### sellShares

Sell shares of a subject.

```js
function sellShares(
    address _subject,
    uint256 _sellAmount,
    uint256 _minReturnAmountAfterFee
) external whenNotPaused returns (uint256 returnAmount_) {}
```

#### Parameters

| Name                       | Type    | Description                                     |
| :------------------------- | :------ | :---------------------------------------------- |
| `_subject`                 | address | Address of subject.                             |
| `_sellAmount`              | uint256 | Amount of subject shares to sell.               |
| `_minReturnAmountAfterFee` | uint256 | Minimum number of shares that must be received. |

#### Return Value

| Name            | Type    | Description                                           |
| :-------------- | :------ | :---------------------------------------------------- |
| `returnAmount_` | uint256 | Amount received in MOXIE from selling subject shares. |

## Events

### UpdateFees

```js
event UpdateFees(
  uint256 _protocolBuyFeePct,
  uint256 _protocolSellFeePct,
  uint256 _subjectBuyFeePct,
  uint256 _subjectSellFeePct
);
```

### UpdateBeneficiary

```js
event UpdateBeneficiary(address _beneficiary);
```

### UpdateFormula

```js
event UpdateFormula(address _formula);
```

### BondingCurveInitialized

```js
event BondingCurveInitialized(
  address _subject,
  address _subjectToken,
  uint256 _initialSupply,
  uint256 _reserve,
  uint32 _reserveRatio
);
```

### SubjectSharePurchased

```js
event SubjectSharePurchased(
  address _subject,
  address _sellToken,
  uint256 _sellAmount,
  address _buyToken,
  uint256 _buyAmount,
  address _beneficiary
);
```

### SubjectShareSold

```js
event SubjectShareSold(
    address \_subject,
    address \_sellToken,
    uint256 \_sellAmount,
    address \_buyToken,
    uint256 \_buyAmount,
    address \_beneficiary
);
```

## Errors

### MoxieBondingCurve_InvalidToken

```js
error MoxieBondingCurve_InvalidToken();
```

### MoxieBondingCurve_InvalidVault

```js
error MoxieBondingCurve_InvalidVault();
```

### MoxieBondingCurve_InvalidBeneficiary

```js
error MoxieBondingCurve_InvalidBeneficiary();
```

### MoxieBondingCurve_InvalidFeePercentage

```js
error MoxieBondingCurve_InvalidFeePercentage();
```

### MoxieBondingCurve_InvalidFormula

```js
error MoxieBondingCurve_InvalidFormula();
```

### MoxieBondingCurve_InvalidTokenManager

```js
error MoxieBondingCurve_InvalidTokenManager();
```

### MoxieBondingCurve_InvalidOwner

```js
error MoxieBondingCurve_InvalidOwner();
```

### MoxieBondingCurve_InvalidSubjectFactory

```js
error MoxieBondingCurve_InvalidSubjectFactory();
```

### MoxieBondingCurve_OnlySubjectFactory

```js
error MoxieBondingCurve_OnlySubjectFactory();
```

### MoxieBondingCurve_InvalidReserveRation

```js
error MoxieBondingCurve_InvalidReserveRation();
```

### MoxieBondingCurve_SubjectAlreadyInitialized

```js
error MoxieBondingCurve_SubjectAlreadyInitialized();
```

### MoxieBondingCurve_SubjectNotInitialized

```js
error MoxieBondingCurve_SubjectNotInitialized();
```

### MoxieBondingCurve_InvalidSubjectSupply

```js
error MoxieBondingCurve_InvalidSubjectSupply();
```

### MoxieBondingCurve_InvalidSubject

```js
error MoxieBondingCurve_InvalidSubject();
```

### MoxieBondingCurve_InvalidDepositAmount

```js
error MoxieBondingCurve_InvalidDepositAmount();
```

### MoxieBondingCurve_InvalidSubjectToken

```js
error MoxieBondingCurve_InvalidSubjectToken();
```

### MoxieBondingCurve_SlippageExceedsLimit

```js
error MoxieBondingCurve_SlippageExceedsLimit();
```

### MoxieBondingCurve_InvalidSellAmount

```js
error MoxieBondingCurve_InvalidSellAmount();
```
